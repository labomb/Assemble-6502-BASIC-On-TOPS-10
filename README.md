# Assembling Microsoft BASIC for the 6502 Microprocessor - Version 1.1

## Introduction

On September 3, 2025 Microsoft officially released the code for 6502 BASIC (found [here](https://github.com/microsoft/BASIC-M6502)) under an open-source license. As detailed there it is indeed a historically significant piece of software (I think many in the vintage computer community would agree). However, the description also indicates that it is 'the complete source code for Microsoft BASIC Version 1.1 for the 6502 microprocessor'. As it turns out, that isn't precisely accurate.

Microsoft developed early iterations of BASIC, for both the 8080 and 6502 processor, on a DEC PDP-10 running the TOPS-10 operating system. The source code for these initial releases of BASIC were written for the MACRO-10 assembler, which ran on TOPS-10. MACRO-10 was a very versatile and robust assembler back in the day, and could be customized via macros to accomplish most anything that a programmer could wish for.

One feature of MACRO-10 was the ability to include files that contained custom macros or symbols, or simply common macros that could be utilized across multiple MACRO-10 projects. These files were referred to as 'universal files', and MACRO-10 includes features that allow building universal files as well as including them in your source files.

In the case of the of the 6502 BASIC source code, you will see the following line near the top:

```
SEARCH M6502
```

The SEARCH pseudo-op tells MACRO-10 to look for a universal file to resolve any symbols not defined in the source code. In this specific case, MACRO-10 would look for a universal file named M6502.UNV.

Unfortunately, this universal file is missing. In looking at the source, it is fairly easy to conclude that the missing universal file is quite critical. It contains the code that generates the 6502 specific opcodes that are required to create a usable binary (or as was sometimes the case at the time, a punched paper tape) that can be loaded and run on the targeted 6502 computer itself.


## A bit of history

When I first acquired the 6502 BASIC source code approaching some 20 years ago (yes, the unofficial source has been floating around various corners of the internet for quite some time now), I searched high and low for the missing universal file... but alas, to no avail. I do vaguely recall reading some conversations in various vintage computer related venues speculating about how Microsoft went about creating usable output from the PDP-10. I think that I saw mention that Microsoft post-processed an output file that was generated by MACRO-10 when assembling the BASIC source. This made sense to me, as MACRO-10 has no ability (that I'm aware of) to generate arbitrary 8-bit binaries with whatever contents that one might desire.

While of course I have no way to verify the details of the process that was actually used, it did occur to me back then that perhaps I can take a similar approach. Specifically, maybe I could create a universal file that would produce output that could subsequently be processed to produce a usable 6502 binary.

At the time, I previously had never done anything with any DEC hardware or software, and thus knew very little about their computers. With that, I decided to learn a bit about the PDP-10 and it's available software so that I might be able assemble the original 6502 BASIC MACRO-10 source without modification. This repository contains the results of the effort.


## What's here

This repository contains the following:

- The source code for two different utilities that can be used to post-process various output files from the MACRO-10 assembly process:
	* genbin is used to process a MACRO-10 .REL binary file
	* genbinl is used to process a MACRO-10 .LST text file
- The MACRO-10 source code for two different universal files that can be used to assemble the original Microsoft 6502 BASIC source file:
	* op6502.mac is the source code for a universal file that produces a .REL binary file that is specifically formatted for the genbin utility
	* op650l.mac is the source code for a universal file that produces a .LST text file that is specifically formatted for the genbinl utility
- Notes on how to transfer files to and from TOPS-10 (in this case running on the simh PDP-10 emulator).
- An overview of the MACRO-10 assembly and genbin process used to produce usable 6502 binaries.
- A patched iteration of Microsoft BASIC for the 6502 (see below).

 
## The build environment

Here is what I am using:

### simh
You can find later 3.x source and Windows binaries [here](https://github.com/simh/simh). There is also the open-simh project and that can be found [here](https://github.com/open-simh/simh), but I still use 3.x.

It is beyond the scope of this document to detail how to set up the simh PDP-10 environment, but there is plenty of documentation online on how to go about doing so. That said, you will need to ensure that simh is configured with DZ11 terminal emulation support to facilitate the file transfer process. The contents of my simh configuration file (pdp10.cfg) are as follows:

```
set cpu tops10
set dz 8b
set tim y2k
att rp0 dskb.dsk
att rp1 dskc.dsk
att lp20 printer.out
att -am dz 2020
boot rp+
```

### TOPS-10
I use the excellent ready-to-go TOPS-10 distribution found [here](https://steubentech.com/~talon/pdp10/). The direct download link is [here](https://steubentech.com/~talon/pdp10/tops10-1.4.tar.bz2). If you are not familiar with TOPS-10, then take some time to read the quick start guide found [here](https://steubentech.com/~talon/pdp10/readme.txt).

### Kermit
You will need a copy of C-Kermit found [here](https://www.kermitproject.org/) or a terminal emulator that supports Kermit file transfers and telnet. See the KERMIT.md file for notes on configuring and using Kermit to transfer files to/from the simh PDP-10. 


## Preparation

Once you have the simh PDP-10 emulator booting TOPS-10 and listening to port 2020 for telnet connections, use C-Kermit or your terminal emulator to connect to it. Then log in as public. Initially, you will want to use Kermit to transfer the universal file sources in this repository (op6500.mac and op650l.mac) to TOPS-10, as well as the original Microsoft 6502 BASIC source file (you may want to rename the Microsoft source file to have a .MAC extension versus .ASM... MACRO-10 uses .MAC by default).

If you wish to use either process described below, you should also copy the original M6502.MAC source file to something like M6502L.MAC. You should then edit the 'SEARCH M6502' pseudo-op line at the top of this source to 'SEARCH M6502L', and transfer it to TOPS-10 as well.

To assemble the universal files:

```
.r macro

*=op6502

NO ERRORS DETECTED

PROGRAM BREAK IS 000000
CPU TIME USED 00:00.000

13P CORE USED

*^c

.
```

Do the same with the op650l.mac file. You will then have two new files on DSKC ... M6502.UNV and M6502L.UNV. You are now ready to use either process described below. Note that either method will produce an identical 8-bit binary.

## Assembling And Generating Binaries

### Assemble to use the MACRO-10 .REL binary file

This is the preferred method (see notes below). To assemble for processing the .REL file, do this:

```
.r macro


*m6502,m6502=m6502
APPLE
ADDITIONAL PRECISION
INTEGER ARRAYS
SAVE AND LOAD
ROM
ROR ASSUMED

NO ERRORS DETECTED

PROGRAM BREAK IS 000000
ABSOLUTE BREAK IS 024330
CPU TIME USED 00:04.567

22P CORE USED

*^c

.
```

Now transfer the resulting M6502.REL file to your PC, and use the genbin utility to create an 8-bit binary:

```
genbin m6502.rel

 *******************************************************
       DEC Macro-10 .REL to 8-Bit Binary Converter
             Scott LaBombard - Jan. 6, 2014
 *******************************************************

Writing binary file... found signature at offset $2800... done!
```

You will now have a file named m6502.bin ready run on your target 6502 system.


### Assemble to use the MACRO-10 .LST text file

This is pretty much the same process as above. Note that if you are assembling the Commodore iteration of BASIC, you cannot use this method unless you modify the original BASIC source file (see 'Commodore Easter Egg' below). To assemble for processing the .LST file, do this:

```
.r macro


*,m6502l=m6502l
APPLE
ADDITIONAL PRECISION
INTEGER ARRAYS
SAVE AND LOAD
ROM
ROR ASSUMED

NO ERRORS DETECTED

PROGRAM BREAK IS 000000
ABSOLUTE BREAK IS 024330
CPU TIME USED 00:02.366

22P CORE USED

*^c

.
```

Note the leading comma in the assembler command... we are only interested in the listing file, not a .REL binary file. Now transfer the resulting M6502L.LST file to your PC, and use the genbinl (not genbin) utility to create an 8-bit binary:

```
genbinl m6502l.lst

 ********************************************
       DEC Macro-10 Listing Binary Generator
          Scott LaBombard - Dec. 19, 2013
 ********************************************

Writing binary file... done!
```

You will now have a file named m6502l.bin ready to run on your target 6502 system.


### The Commodore Easter Egg

Microsoft included a delightfully clever Easter egg in the 6502 BASIC source code that was only present when assembling BASIC for the Commodore target (REALIO=3). You can read about the details [here](https://www.pagetable.com/?p=43#comment-2506), but briefly if you enter 'WAIT 6502,1' at the BASIC prompt, the word MICROSOFT! will appear on the Commodore display at the top left. Funny stuff!

Here is the bulk of the code for the Easter egg in the BASIC source code, used by the FNWAIT routine if assembling for the Commodore target:

```
	JMP	FADDT		;[Y]=ARGEXP..
	XLIST
.XCREF
IFN	REALIO-3,<ZSTORDO=STORDO>
IFE	REALIO-3,<
ZSTORD:!	LDA	POKER
	CMPI	146
	BNE	STORDO
	LDA	POKER+1
	SBCI	31
	BNE	STORDO
	STA	POKER
	TAY
	LDAI	200
	STA	POKER+1
MRCHKR:	LDXI	12
IF1,<
MRCHR:	LDA	60000,X,>
IF2,<
MRCHR:	LDA	SINCON+36,X,>
	ANDI	77
	STADY	POKER
	INY
	BNE	PKINC
	INC	POKER+1
PKINC:	DEX
	BNE	MRCHR
	DEC	ANDMSK
	BNE	MRCHKR
	RTS
IF2,<PURGE ZSTORD>>
.CREF
	LIST
FADD5:	JSR	SHIFTR		;DO A LONG SHIFT.
	BCC	FADD4		;CONTINUE WITH ADDITION.
```

Note that this code is only assembled with the Commodore configuration and no other. Also note the presence of the XLIST and .XCREF pseudo-ops. These pseudo-ops disable output to the listing file and cross-reference table... so even though the code is generated for binary output (.REL file), no output is present in the listing file (.LST file). You can see the gap in the assembly listing output:

```
	153502	000000	000114			JMP	FADDT		;[Y]=ARGEXP..
	153503	000000	000166
	153504	000000	000327
						XLIST
						LIST
	153556	000000	000040		FADD5:	JSR	SHIFTR		;DO A LONG SHIFT.
	153557	000000	000245
	153560	000000	000330
	153561	000000	000220			BCC	FADD4		;CONTINUE WITH ADDITION.
```

Note that code was indeed assembled between addresses 153504 and 153556 (41 bytes), but the listing for this code is missing. No doubt an attempt to hide the Easter egg code a bit!

As you may have surmised by now, the genbinl utility will not be able to generate binary output for the missing listing lines, and thus the resulting Commodore binary will not be correct. However, if you use the genbin utility along with a .REL file for the Commodore configuration, there is no issue.

Of course you can opt to remove or comment out the XLIST/LIST and .XCREF/.CREF lines from the original source if you so choose.


## Patched 6502 BASIC

The `patched` directory contains m6502p.mac, which is ... wait for it ... a patched iteration of the original Microsoft source code. This is what was patched (and why):

### Apple

If you were to try and run the Apple binary created from the Microsoft source on an Apple (or emulator), you would soon discover that it does not work:

![Apple BASIC Error](/assets/images/apple_error.jpg)

The problem is with the code associated with line input from the console. As you can see, the prompts for input are somewhat messed up, and any input provided results in the '?SN ERROR' message. If you were to find a way around these issues, you would also discover that the BASIC prompt isn't the now famous ']' character, among other things.

Some years back I did quite a bit of work on disassembling and otherwise exploring the first iteration of Applesoft v1 (and the early release of v2 as well), which were distributed on cassette tape. While I found that the Applesoft release was indeed based on the Microsoft source code almost verbatim, it did contain several patches related to the issues described above. With that, I applied those specific patches that I found in the Applesoft binaries to the Microsoft source, and that fixed the issues. Here is the binary generated from the patched MACRO-10 source running on an emulator:

![Apple BASIC Fixed](/assets/images/apple_patched.jpg)

I also tested the cassette SAVE and LOAD routines running on the [mameUI](https://messui.1emulation.com/) emulator (it supports the cassette interface), and I can report they also work as expected.

### Commodore

While there are no functional issues with the Commodore binary produced by the genbin utilities, it did not exactly match the Commodore Pet Level 2 BASIC ROMs. So I added a couple of very minor patches to the Microsoft source that will ensure an identical byte-for-byte match to the Level 2 ROMS is generated. One patch enables the ability to PEEK the ROM contents (this was disabled in Level 1, but enabled in Level 2), and the other adds a single NOP byte to the NEWSTT routine. Be sure to set REALIO=3, and LNGERR==1 to generate the proper binary.

Note that all patches that were applied to the original Microsoft source can be found by searching for *** PATCH *** in this file.


## Miscellaneous

I have tested several configurations to ensure that the gendin and genbinl utilities produced usable, and matching, binaries. That said, I cannot test every configuration possible with the Microsoft source, and I cannot run the binaries produced on every target (simulator anyone? :)). With that, I would recommend that you use genbin with a .REL file as I do. Generally, I would prefer to process a binary versus a text file if given the choice. 

Last, both of the genbin utilities have been successfully compiled and tested on Windows (mingw64) and Ubuntu Linux.

Happy BASIC hacking! :slightly_smiling_face:
